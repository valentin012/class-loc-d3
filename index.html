<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Class-loc-d3 by valentin012</title>

	<link rel="stylesheet" href="stylesheets/ol.css">
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">

	<style>

#map {
  width: 1200px;
  height: 750px;
  overflow: hidden;
  margin: 0;
  padding: 0;
  float: left;
}

#control {
  overflow: hidden;
  padding: 20px;
  margin: 5px;
}

select {
    margin-right: 10px;
    margin-top: 5px;
    width: 180px;
}


.links {
  //width: 100%;
  //height: 100%;

 position: absolute;
}


div.tooltip {	
    position: absolute;			
    text-align: center;			
    width: 90px;					
    height: 16px;					
    padding: 2px;				
    font: 12px sans-serif;		
    background: lightsteelblue;	
    border: 0px;		
    border-radius: 8px;			
    pointer-events: none;
}

</style>
<script src="javascripts/d3.min.js"></script>
<script src="javascripts/ol.js"></script>


    <meta name="viewport" content="width=device-width">
 
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>D3 Visualization tool (Class-loc-d3)</h1>
        <p></p>

        <p class="view"><a href="https://github.com/valentin012/class-loc-d3">View the Project on GitHub <small>valentin012/class-loc-d3</small></a></p>


        <ul>
          <li><a href="https://github.com/valentin012/class-loc-d3/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/valentin012/class-loc-d3/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/valentin012/class-loc-d3">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <p> This tool visualizes the estimated class locations from students' bluetooth and location data. Note, that it does NOT show the original data here. This data was randomly generated for visualization purposes.
        </p>
<p id="demo"></p>
<div id="tooltip" class="tooltip"></div>
<div id="control">
<label> <input type="checkbox" name="radius" value="radius" id="radius" onclick="updateRadius();"> 200m radius </label>
</div>
<div id="map"></div>





      </section>
     
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
    <script type="application/javascript">


var usercolor = d3.scale.category10().domain(d3.range(1000));

function getColorForUser(d) {

    if (!("id" in d)) {
                 return usercolor(d['user']);                
            } else {
                return 'red';
            }
};


// Create the Google Mapâ€¦
var map = new ol.Map({
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          })
        ],
        target: 'map',
        view: new ol.View({
          center: ol.proj.fromLonLat([12.521238,55.784875]),
          zoom: 14
        })
      });
	  

var RangeRadius = 355.68095012346;
//var center = ol.proj.fromLonLat([12.521238,55.784875]);
//var edgeCoordinate = [center[0] + RangeRadius, center[1]];
//var wgs84Sphere = new ol.Sphere(6378137);
//var groundRadius = wgs84Sphere.haversineDistance(
//    ol.proj.transform(center, 'EPSG:3857', 'EPSG:4326'), 
//    ol.proj.transform(edgeCoordinate, 'EPSG:3857', 'EPSG:4326')
//);
//alert(groundRadius);


var RangeSource = new ol.source.Vector({
      //create empty vector
    });
var RangeLayer = new ol.layer.Vector({
		source: RangeSource,
      style: [
    new ol.style.Style({
        stroke: new ol.style.Stroke({
            color: 'red',
            width: 1
        }),
        fill: new ol.style.Fill({
            color: 'rgba(255, 0, 0, 0.05)'
        })
    })]}); 
map.addLayer(RangeLayer);

var ClusterSource = new ol.source.Vector({
      //create empty vector
    });
var ClusterLayer = new ol.layer.Vector({
		source: ClusterSource,
      style: [
    new ol.style.Style({
        stroke: new ol.style.Stroke({
            color: 'red',
            width: 1
        }),
        fill: new ol.style.Fill({
            color: 'rgba(255, 0, 0, 0.5)'
        })
    })]}); 
map.addLayer(ClusterLayer);


var StudentSource = new ol.source.Vector({
      //create empty vector
    });
var StudentLayer = new ol.layer.Vector({
		source: StudentSource});
map.addLayer(StudentLayer);

var tooltip = document.getElementById('tooltip');
var overlay = new ol.Overlay({
  element: tooltip,
  offset: [10, 0],
  positioning: 'bottom-left'
});
map.addOverlay(overlay);

function displayTooltip(evt) {
  var pixel = evt.pixel;
  var feature = map.forEachFeatureAtPixel(pixel, function(feature) {
    return feature;
  });

  if ((feature) && (feature.get('name'))) {
	tooltip.style.display = '';
    overlay.setPosition(evt.coordinate);
    tooltip.innerHTML = feature.get('name');
  }
  else {
  tooltip.style.display = 'none';
  }
};

map.on('pointermove', displayTooltip);
	

var cluster_data;
var locations;


d3.csv("data/dummy_cluster.csv", function(error, data) {
  if (error) throw error; 
    cluster_data = data;  
});


var student_entries;


d3.csv("data/dummy_locs.csv", function(error, data) {
  if (error) throw error;
 
    locations = data;   
    var course_set = new Set();
    data.forEach(function(d) {
        course_set.add(d['course'] + ' (' + d['term'] + ')');
    });
    
    
    var course_dict = {};
    var course_user = {};
    course_set.forEach(function(d) {
        course_dict[d] = new Array();
        course_user[d] = new Set();
    });
    
    locations.forEach(function(d) {
        course_user[d['course'] + ' (' + d['term'] + ')'].add(d['date']);
    });
    
    
    course_set.forEach(function(d) {
        course_user[d].forEach(function(dd) {
            var option = document.createElement("option");
            option.text = dd;
            option.value = dd;
            course_dict[d].push(option);
            
        });

    });
    console.log(course_set);
    
    var combo =document.createElement("select");
    combo.id = 'course_combo';    
    
    
    var entries = Array.from(course_set);
    entries.sort();
    entries.forEach(function(d) {
    var option = document.createElement("option");
        option.text = d;
        option.value = d;
        combo.add(option,null);
        });
    combo.addEventListener("change", selectCourse);
    combo.addEventListener("keyup", selectCourse);
    document.getElementById('control').appendChild(combo);
    
    combo =document.createElement("select");
    combo.id = 'date_combo';
    combo.addEventListener("change", selectDate);
    combo.addEventListener("keyup", selectDate);
    document.getElementById('control').appendChild(combo);
    
    student_entries = course_dict;
    
});

//var layer;
var cluster_circle = [];

function selectCourse(sel) {
    console.log(this.value);
    val =  this.value;
    
	updateRadius();
	
    var combo = document.getElementById("date_combo");
    
    var length = combo.options.length;
        for (i = 0; i < length; i++) {
          combo.options[i] = null;
        }
    
    combo.options.length = 0;
    
       
    var option = document.createElement("option");
    option.text = "All";
    option.value = "All";
    combo.add(option,null);
            
       
    
    student_entries[val].forEach(function(d) {        
        combo.add(d,null);
        });
    
    
    combo.options[0].selected = 'selected';
    selectDate(null);
};


function selectDate(sel) {
    
    var val =  document.getElementById("date_combo").value;
    var selected_key = document.getElementById("course_combo").value;
    
    console.log(val);
    
    
    var dataset = new Array();
	
	StudentLayer.getSource().clear();
	ClusterLayer.getSource().clear();
	RangeLayer.getSource().clear();
    
    if(val == 'All') {
    cluster_data.forEach(function(d) {
    
        key = d['course'] + ' (' + d['term'] + ')'
            if(key == selected_key) {
                
                var circle = new ol.geom.Circle(ol.proj.fromLonLat([parseFloat(d['lon']), parseFloat(d['lat'])]), 60);
				var CircleFeature = new ol.Feature(circle);
				CircleFeature.set('name',d['date'] + "-" + d['time']);
				ClusterLayer.getSource().addFeature(CircleFeature); 
            }
       });
    
    
    }
    else {
    
		cluster_data.forEach(function(d) {
		
			key = d['course'] + ' (' + d['term'] + ')'
				if((key == selected_key) && (d['date'] == val)) {
					
					var circle = new ol.geom.Circle(ol.proj.fromLonLat([parseFloat(d['lon']), parseFloat(d['lat'])]), 60);
					var CircleFeature = new ol.Feature(circle);
					CircleFeature.set('name',d['time']);
					ClusterLayer.getSource().addFeature(CircleFeature); 
					
					var circle = new ol.geom.Circle(ol.proj.fromLonLat([parseFloat(d['lon']), parseFloat(d['lat'])]), RangeRadius);
					var CircleFeature = new ol.Feature(circle);
					RangeLayer.getSource().addFeature(CircleFeature); 
				}
		   });
		   
		   
		locations.forEach(function(d) {
			key = d['course'] + ' (' + d['term'] + ')' 
			if((d['date'] == val) && (key == selected_key)){
				
				var circle = new ol.geom.Circle(ol.proj.fromLonLat([parseFloat(d['lon']), parseFloat(d['lat'])]), 30);
				var CircleFeature = new ol.Feature(circle);
				CircleFeature.set('name',d['user'] + " (" + d['time'] + ")");
				var ucol = getColorForUser(d);
				var style = new ol.style.Style({
												stroke: new ol.style.Stroke({color: ucol,width: 1}),
												fill: new ol.style.Fill({color: ucol + 'AA'})
												});
											
				CircleFeature.setStyle(style);
				StudentLayer.getSource().addFeature(CircleFeature);       
			}
		});
		   
    }
};



function updateRadius() {
	
    RangeLayer.setVisible(document.getElementById("radius").checked);
};



</script>
    
  </body>
</html>
